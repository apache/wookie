<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
    <head>
        <style type="text/css">
            body {
                width: 481px;
                height: 302px;
                font-family: Segoe UI;
                font-size: 11px;
                background: #eef3fa;
                margin: 0px;
                padding: 0px;
            }
            
            h1 {
                font-family: Segoe UI;
                font-size: 15px;
                font-weight: bold;
                margin: 0px;
            }
            
            select {
                font-family: Segoe UI;
                font-size: 11px;
                border: 1px solid #d1d6dd;
                padding: 2px 4px;
                margin: 1px;
                height: 19px;
            }
            
            input {
                font-family: Segoe UI;
                font-size: 11px;
                background: transparent;
                border: 0;
                padding: 0px 4px;
                margin: 0px;
            }
            
            input.search {
                font-style: italic;
                color: #77797d;
                background: transparent;
                border: 0;
                padding: 0px 4px;
            }
            
            table {
                border-collapse: collapse;
                table-layout: fixed;
            }
            
            table thead td {
                font-family: Segoe UI;
                font-size: 11px;
                padding: 2px;
	            overflow: hidden;
	            white-space:nowrap;
	            color: #77797d;
	            border: 1px #d1d6dd solid;
	            background: #edf2f9;
	            filter: progid:DXImageTransform.Microsoft.gradient(startColorStr=#f0f5fb, endColorStr=#e7ebf2);
                cursor: default;
            }
            
            table tbody td {
                font-family: Segoe UI;
                font-size: 11px;
                text-overflow: ellipsis;
	            overflow: hidden;
	            white-space: nowrap;
	            height: 16px;
                cursor: default;
                padding: 0px 3px 1px 3px;
                border-top: 1px solid transparent;
            }
            
            table tbody th {
                font-family: Segoe UI;
                font-size: 11px;
                text-overflow: ellipsis;
	            overflow: hidden;
	            white-space: nowrap;
	            height: 16px;
                cursor: default;
                padding: 0px 3px 1px 3px;
                border-top: 1px solid #fafcfe;
                text-align:left;
                background: #fafcfe;
            }
            
            table tbody span {
                white-space: nowrap;
            }
            
            table td.track {
                width: 16px;
                text-align:right;
            }
            
            table td.title {
                width: 168px;
            }

            table td.duration {
                width: 44px;
                text-align: right;
            }
            
            table td.author {
                width: 96px;
            }

            table td.album {
                width: 136px;
             }
             
            table th.album {
                width: 136px;
             }
            
            table tr.normal {
                background: #eef3fa;
            }
           
            table tr.odd {
                background: #fafcfe;
            }
            
            table tr.hover {
                background: #dddddd;
            }
            
            table tr.hover td {
                padding-top: 1px;
            }
            
            table tr.current {
                background: #3399ff;
            }
            
            table tr.current td {
                color: white;
            }
            
            table tr.album td {
                border-top: 1px solid #a6b9dd;
            }
            
            table tr.album th {
                border-top: 1px solid #a6b9dd;
            }
        </style>
        <script language="javascript" src="player.js"></script>
        <script language="javascript" type="text/javascript">
            var updateResultsTimer;
            var resultsRowHeight = 16;
            var resultsHeight = 256;
            var numResultsToShow = Math.floor( resultsHeight / resultsRowHeight ) + 1;
            var currentMediaID = null;
            
            var currentPlaylist = null;
            var currentBegin = -1;
            var currentEnd = -1;
            
            var resultsScroll;
            var searchResultsTable;
            var resultRows;
            var nowPlaying;
            
            var trackNumberAtom;
            var titleAtom;
            var albumTitleAtom;
            var albumArtistAtom;
            var uniqueFileIdentifierAtom;
            var genreAtom;
            var yearAtom;
            var player;
            
            function buildPlaylistList() {
                var playlistSelect = document.getElementById( "playlistSelect" );
                var playlists = player.playlistCollection.getAll();
                
                playlistSelect.options.length = 0;
                
                var option = document.createElement( "option" );
                option.value = "";
                option.text = "-- Playlists --";
                playlistSelect.add( option );
                
                for (var i = 0; i < playlists.count; i++) {
                    option = document.createElement( "option" );
                    option.value = playlists.item(i).name;
                    option.text = playlists.item(i).name == "Gadget Now Playing" ? "Now Playing" : playlists.item(i).name;
                    playlistSelect.add( option );
                }
            }
            
            function onLoad() {
                player = System.Gadget.document.parentWindow.player;
                
                var innerHTML = '<table style="position:relative;top:0px" id="searchResultsTable"><tbody>';
                for (var i = 0; i < numResultsToShow * 2; i++) {
                    innerHTML += 
                                    '<tr onmouseover="if (this.className != \'current\') this.className=this.outClassName+\' hover\';" onmouseout="if (this.className != \'current\') this.className = this.outClassName;" ondblclick="onSelectPlaylistItem( currentBegin + ' + i + ' )">' +
                                        '<th class="album"><span></span></td>' +
                                        '<td class="track"><span></span></td>' +
                                        '<td class="title"><span></span></td>' +
                                        '<td class="duration"><span></span></td>' +
                                        '<td class="author"><span></span></td>' +
                                    '</tr>';
                }
                
                innerHTML += '</tbody></table>';
                document.getElementById( 'searchResultsDiv' ).innerHTML = innerHTML;
                
                searchResultsTable = document.getElementById( "searchResultsTable" );
                var rows = searchResultsTable.rows;
                resultRows = new Array();
                for (var i = 0; i < numResultsToShow * 2; i++) {
                    resultRows[i] = new Object();
                    resultRows[i].row = rows[i];
                    resultRows[i].spans = rows[i].getElementsByTagName( "span" );
                }
                
                resultsScroll = document.getElementById( "resultsScroll" );
                
                trackNumberAtom = player.mediaCollection.getMediaAtom( "WM/TrackNumber" );
                uniqueFileIdentifierAtom = player.mediaCollection.getMediaAtom( "WM/UniqueFileIdentifier" );
                albumTitleAtom = player.mediaCollection.getMediaAtom( "WM/AlbumTitle" );
                albumArtistAtom = player.mediaCollection.getMediaAtom( "WM/AlbumArtist" );
                genreAtom = player.mediaCollection.getMediaAtom( "WM/Genre" );
                yearAtom = player.mediaCollection.getMediaAtom( "WM/Year" );
                
                buildPlaylistList();                
                
                currentMediaID = player.currentMedia.getItemInfo("WM/UniqueFileIdentifier") + player.currentMedia.name;
                setCurrentPlaylist( player.currentPlaylist );
            }
            
            function getAuthorString( media ) {
                var authorCount = media.getAttributeCountByType( "Author", "" );
                var authorString = "";
                for (var i = 0; i < authorCount; i++) {
                    authorString += media.getItemInfoByType( "Author", "", i );
                    if (i + 1 < authorCount) authorString += ";";
                }
                
                return authorString;
            }
            
            function getTimeString( time ) {
                var hours = Math.floor( time / 3600 );
                var minutes = Math.floor( (time % 3600) / 60 );
                var seconds = Math.floor( time % 60 );
                
                var timeString = "";
                if (time >= 3600) timeString = hours + ":";
                timeString += (hours > 0 && minutes < 10 ? "0" : "" ) + minutes + ":" + (seconds < 10 ? "0" : "" ) + seconds;
                
                return timeString;
            }
            
            function setCurrentPlaylist( playlist ) {
                currentPlaylist = playlist;
                setPlaylistName( currentPlaylist.name );
                
                var searchResults = document.getElementById( "searchResultsDiv" );
                resultsScroll.scrollTop = 0;
                searchResults.style.height = (playlist.count * resultsRowHeight) + "px";
                
                currentBegin = currentEnd = -1;
                updateResults();
            }
            
            function updateResults() {
                if (!currentPlaylist) return;
                
                var begin = Math.min( Math.max( 0, currentPlaylist.count - numResultsToShow ), Math.floor( resultsScroll.scrollTop / resultsRowHeight ) );
                var end = Math.min( currentPlaylist.count, begin + numResultsToShow );
                
                if (begin < currentBegin || end > currentEnd) {
                    if (begin < currentBegin)
                        begin = Math.max( 0, begin - numResultsToShow );
                    else
                        end = Math.min( currentPlaylist.count, end + numResultsToShow);

                    searchResultsTable.style.top = (begin * resultsRowHeight) + "px";
                    var previousAlbum = null;
                    var previousAlbumArtist = null;
                    var albumLine = 1;
                    var span, spans, item;
                    var track, author, title, duration, album;
                    var foundCurrent = false;
                    for (var i = 0, j = begin; i < numResultsToShow * 2; i++, j++) {
                        row = resultRows[i].row;
                        spans = resultRows[i].spans;
                        
                        if (j < end) {
                            item = currentPlaylist.item( j );
                            
                            var track = item.getItemInfoByAtom( trackNumberAtom );
                            var author = getAuthorString( item );
                            var title = item.name;
                            var duration = getTimeString( item.duration );
                            var album = item.getItemInfoByAtom( albumTitleAtom );
                            var albumArtist = item.getItemInfoByAtom(albumArtistAtom);
                            
                            if (j == begin) {
                                if (begin == 0 || album != (previousAlbum = currentPlaylist.item( begin - 1 ).getItemInfoByAtom( albumTitleAtom )) ||
                                            albumArtist != (previousAlbum = currentPlaylist.item( begin - 1 ).getItemInfoByAtom( albumArtistAtom ))) {
                                    albumLine = 1;
                                } else if (begin > 1 && (album != (previousAlbum = currentPlaylist.item( begin - 2 ).getItemInfoByAtom( albumTitleAtom )) ||
                                                   albumArtist != (previousAlbum = currentPlaylist.item( begin - 2 ).getItemInfoByAtom( albumArtistAtom )))) {
                                    albumLine = 2;
                                } else if (begin > 2 && (album != (previousAlbum = currentPlaylist.item( begin - 3 ).getItemInfoByAtom( albumTitleAtom )) ||
                                                   albumArtist != (previousAlbum = currentPlaylist.item( begin - 3 ).getItemInfoByAtom( albumArtistAtom )))) {
                                    albumLine = 3;
                                } else if (begin > 3 && (album != (previousAlbum = currentPlaylist.item( begin - 4 ).getItemInfoByAtom( albumTitleAtom )) ||
                                                   albumArtist != (previousAlbum = currentPlaylist.item( begin - 4 ).getItemInfoByAtom( albumArtistAtom )))) {
                                    albumLine = 4;
                                } else {
                                    albumLine = 5;
                                }
                            } else if (album != previousAlbum || albumArtist != previousAlbumArtist) {
                                albumLine = 1;
                            }
                            
                            row.style.display = "block";
                            
                            var className = albumLine == 1 && (i > 0 || begin > 0) ? "album " : "";
                            if (!foundCurrent && currentMediaID == item.getItemInfoByAtom( uniqueFileIdentifierAtom ) + item.name) {
                                className += "current";
                                foundCurrent = true;
                            } else {
                                className += j % 2 == 1 ? "odd" : "normal";
                            }
                            
                            row.className = className;
                            row.outClassName = className;

                            span = spans[0]; 
                            switch (albumLine) {
                                case 1:
                                    span.style.fontWeight = "bold";
                                    span.title = span.innerHTML = album;
                                    break;
                                case 2:
                                    span.style.fontWeight = "normal";
                                    span.title = span.innerHTML = albumArtist;
                                    break;
                                case 3:
                                    span.style.fontWeight = "normal";
                                    var genre = item.getItemInfoByAtom(genreAtom);
                                    span.title = span.innerHTML = genre;
                                    break;
                                case 4:
                                    span.style.fontWeight = "normal";
                                    var year = item.getItemInfoByAtom(yearAtom);
                                    span.title = span.innerHTML = year;
                                    break;
                                default:
                                    span.style.fontWeight = "normal";
                                    span.title = span.innerHTML = "";
                            }
                            
                            span = spans[1]; span.title = span.innerHTML = track;
                            span = spans[2]; span.title = span.innerHTML = title;
                            span = spans[3]; span.title = span.innerHTML = duration;
                            span = spans[4]; span.title = span.innerHTML = author;
                        } else {
                            row.style.display = "none";
                            span = spans[0]; span.title = span.innerHTML = "";
                            span = spans[1]; span.title = span.innerHTML = "";
                            span = spans[2]; span.title = span.innerHTML = "";
                            span = spans[3]; span.title = span.innerHTML = "";
                            span = spans[4]; span.title = span.innerHTML = "";
                        }
                        
                        albumLine++;
                        previousAlbum = album;
                        previousAlbumArtist = albumArtist;
                    }
                    
                    currentBegin = begin;
                    currentEnd = end;
                }
                
                updateResultsTimer = 0;
            }
            
            function search( string ) {
                if (string.length == 0) {
                    setCurrentPlaylist( player.currentPlaylist );
                    return;
                }
                
                query = player.mediaCollection.createQuery();
                query.addCondition("Title", "Contains", string);
                query.beginNextGroup();
                query.addCondition("Author", "Contains", string);
                query.beginNextGroup();
                query.addCondition("WM/AlbumTitle", "Contains", string);
                query.beginNextGroup();
                var playlist = player.mediaCollection.getPlaylistByQuery( query, "audio", "WM/AlbumArtist", true );
                playlist.name = "Search Results: \"" + string + "\"";
                setCurrentPlaylist( playlist );
            }
            
            function onSearchBlur( search ) {
                if (search.value == "") {
                    document.getElementById( "searchDiv" ).style.background = "#f6f9fc";
                    search.value = "Search";
                    search.className = "search";
                }
            }
            
            function onSearchFocus( search ) {
                if (search.className == "search") {
                    document.getElementById( "searchDiv" ).style.background = "#ffffff";
                    search.value = "";
                    search.className = "";
                }
            }
            
            function onResultsScroll() {
                if (updateResultsTimer == 0) {
                    updateResultsTimer = setTimeout( updateResults, 1 );
                }
            }
            
            function setPlaylistName( name ) {
                if (name == "Gadget Now Playing")
                    document.getElementById( "playlistSelect" ).options[0].text = "Now Playing";
//                    document.getElementById( "playlistName" ).innerHTML = "Now Playing";
                else
                    document.getElementById( "playlistSelect" ).options[0].text = name;
//                    document.getElementById( "playlistName" ).innerHTML = name;
            }
            
            function setNowPlaying( playlist ) {
                if (player.playlistCollection.getByName( "Gadget Now Playing" ).count > 0) {
                    var nowPlayingList = player.playlistCollection.getByName( "Gadget Now Playing" );
                    for (var i = 0; i < nowPlayingList.count; i++)
                        player.playlistCollection.remove( nowPlayingList.item( i ) );
                }
                nowPlaying = player.playlistCollection.newPlaylist( "Gadget Now Playing" );
                for (var i = 0; i < playlist.count; i++) {
                    nowPlaying.appendItem( playlist.item( i ) );
                }
                
                buildPlaylistList();
            }
            
            function onPlaylistSelect( name ) {
                if (player.playlistCollection.getByName( name ).count > 0) {
                    setCurrentPlaylist( player.playlistCollection.getByName( name ).item( 0 ) );
                    document.getElementById( "searchString" ).value = "";
                    onSearchBlur( document.getElementById( "searchString" ) );
                }
                
                document.getElementById( "playlistSelect" ).selectedIndex = 0;
            }
            
            function onSelectPlaylistItem( item ) {
                if (currentPlaylist.name != "Gadget Now Playing") {
                    setNowPlaying( currentPlaylist );
                    currentPlaylist = nowPlaying;
                    setPlaylistName( nowPlaying.name );
                    player.currentPlaylist = nowPlaying;
                }
                
                player.controls.currentItem = player.currentPlaylist.item( item );
                player.controls.play();
                loadSettings();
                
                currentBegin = currentEnd = -1;
                updateResults();
            }
            
            function onCurrentItemChange() {
                if (player.currentMedia) {
                    currentMediaID = player.currentMedia.getItemInfo("WM/UniqueFileIdentifier") + player.currentMedia.name;
                } else {
                    currentMediaID = null;
                }
                
                currentBegin = currentEnd = -1;
                updateResults();
            }
        </script>
    </head>
    <body onload="onLoad()">
        <div style="border: 1px solid #666666; padding: 1px;width:480px;height:300px;background: #eef3fa;">
            <div id="searchDiv" style="float:right;background: #f6f9fc;border: 1px solid #d1d6dd;">
                <input type="text" id="searchString" class="search" style="vertical-align:middle" onkeyup="search(this.value)" value="Search" onfocus="onSearchFocus( this )" onblur="onSearchBlur( this )"/>
                <img src="images/search.png" style="vertical-align:middle;margin:1px;"/>
            </div>
            <select id="playlistSelect" onchange="onPlaylistSelect( this.value )">
            </select>
<!--            <div id="playlistName" style="margin:4px 8px;font-size:13px;font-weight:bold;font-family:Segoe UI">Current Playlist</div>
-->            <table>
                <thead>
                    <tr>
                        <td class="album">Album</td>
                        <td class="track">&nbsp;</td>
                        <td class="title">Title</td>
                        <td class="duration">Length</td>
                        <td class="author">Artist</td>
                    </tr>
                </thead>
            </table>
            <div style="height:256px;overflow-y:auto" id="resultsScroll" onscroll="onResultsScroll()"  onselectstart="return false">
                <div id="searchResultsDiv">
                    
                </div>
            </div>
       </div>
    </body>
</html>
